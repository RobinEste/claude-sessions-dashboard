# Code Review — 2026-02-23 (v2)

## Samenvatting

| Aspect | Waarde |
|--------|--------|
| **Verdict** | **CHANGES REQUESTED** |
| **Bestanden** | 4 gereviewed |
| **Bevindingen** | 5 (gefilterd van 15) |
| **Agents** | security-sentinel, avg-privacy-guardian, logic-correctness, async-data-integrity, convention-checker, duplication-checker, python-specialist |

## Vereist menselijke beoordeling

### [HIGH] ASD-001 — add_tasks: TOCTOU race leidt tot verloren task-updates bij gelijktijdige writes
**Bestand:** `lib/store.py:306-329` | **Confidence:** 0.85 | **Agent:** async-data-integrity

`add_tasks` volgt het patroon: (1) `get_session` (read), (2) muteer in-memory, (3) `_save_session` (write). Er is geen locking. Als twee processen tegelijk `add_tasks` aanroepen op dezelfde sessie, overschrijft de laatste `_save_session` de wijzigingen van de eerste volledig. De atomic write via `os.replace` beschermt alleen tegen file-corruptie, niet tegen lost updates.

**Suggestie:** Gebruik `fcntl.flock` voor file-locking rond de read-modify-write cyclus.

---

### [HIGH] ASD-002 — cleanup_stale_sessions: heartbeat tussen check en save sluit actieve sessie onterecht
**Bestand:** `lib/store.py:485-502` | **Confidence:** 0.90 | **Agent:** async-data-integrity

Tussen `get_stale_sessions()` en `_save_session` kan een actieve Claude-sessie een heartbeat sturen. `cleanup_stale_sessions` heeft de stale snapshot al in geheugen en overschrijft de live heartbeat met `status=COMPLETED`. Een actieve sessie wordt onterecht afgesloten.

**Suggestie:** Hervalideer de heartbeat direct voor de write: herlaad de sessie en check opnieuw of deze nog stale is.

## Overige bevindingen

### [MEDIUM] PYT-001 — update_task accepteert elke status-string zonder validatie
**Bestand:** `lib/store.py:332-350` | **Confidence:** 0.92 | **Agent:** python-specialist

De parameter `status: str` in `update_task` wordt niet gevalideerd tegen geldige waarden. Directe aanroep met ongeldige waarde schrijft corrupte data naar disk.

**Suggestie:** Voeg `VALID_TASK_STATUSES` set toe en valideer bij entree.

---

### [MEDIUM] ASD-003 — cleanup_stale_sessions slaat last_heartbeat-update over
**Bestand:** `lib/store.py:485-502` | **Confidence:** 0.95 | **Agent:** async-data-integrity

Alle andere write-operaties updaten `session.last_heartbeat` voor `_save_session`. `cleanup_stale_sessions` laat `last_heartbeat` op de stale waarde staan, waardoor `ended_at` recenter is dan `last_heartbeat`.

**Suggestie:** Voeg `session.last_heartbeat = session.ended_at` toe.

---

### [MEDIUM] PYT-002 — cleanup_stale_sessions absorbeert exceptions zonder logging
**Bestand:** `lib/store.py:485-502` | **Confidence:** 0.90 | **Agents:** python-specialist, logic-correctness

`except Exception: continue` swallowt alle fouten. Bij geautomatiseerde cleanup (launchd) is falen onzichtbaar.

**Suggestie:** Voeg `logging.warning` toe met session_id en exception details.

## Compound Learning

De volgende eerder gerapporteerde issues zijn gefixt en vastgelegd als solution documents:
- **ASD-001**: Race condition op task-ID generatie → `docs/solutions/database/SOL-2026-001-race-condition-id-generatie.md`
- **LOG-001-DUP-001**: task_summary duplicatie en inconsistentie → `docs/solutions/logic/SOL-2026-002-task-summary-duplicatie-en-inconsistentie.md`
- **ASD-003**: Partial failure in batch operatie → `docs/solutions/database/SOL-2026-003-partial-failure-batch-operatie.md`
