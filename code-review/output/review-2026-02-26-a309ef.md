# Code Review — 2026-02-26 (C4 + C5 + D1)

## Samenvatting

| Aspect | Waarde |
|--------|--------|
| **Verdict** | changes_requested |
| **Risk Score** | 100/100 (Hoog) |
| **Bestanden** | 8 gereviewed |
| **Bevindingen** | 7 (gefilterd van 14) |
| **Agents** | security-sentinel, logic-correctness, async-data-integrity, python-specialist, performance-reviewer, convention-checker, duplication-checker, dead-code-detector |

## Vereist menselijke beoordeling

### ASD-001 (CRITICAL) — OPGELOST
**Index read-modify-write race: concurrent saves overwrite each other's entries**
- `lib/store.py:337-341`
- Fix: `_index_lock()` context manager met `fcntl.flock` toegevoegd aan `_update_index` en `_remove_from_index`

### ASD-002 (HIGH) — OPGELOST
**Index removal in archive_old_sessions valt buiten session lock**
- `lib/store.py:904-907`
- Fix: `_remove_from_index(sid)` verplaatst naar binnen het `with _session_lock(sid)` block in beide archive functies

### PRF-001 (HIGH) — OPGELOST
**list_sessions leest elke session-file individueel na index-filtering — ondermijnt het index-doel**
- `lib/store.py:700-707`
- Fix: `full_load` parameter + `_session_from_index()` helper voor lichtgewicht Session objecten

## Overige bevindingen

### MERGED-003 (MEDIUM) — OPGELOST
**Lege index niet te onderscheiden van ontbrekende index** → separate exists() + size check

### MERGED-001 (MEDIUM) — OPGELOST
**TOCTOU race in _safe_read_json** → `O_NOFOLLOW` via `os.open()` voor atomaire symlink-weigering

### MERGED-002 (MEDIUM) — OPGELOST
**ValueError handler lekt interne bestandsnamen** → generieke "Invalid request" naar client, details naar log

### CON-001 (MEDIUM) — False positive
**TestRebuildIndex mist _isolate_store fixture** → `autouse=True` fixture geldt voor hele module
