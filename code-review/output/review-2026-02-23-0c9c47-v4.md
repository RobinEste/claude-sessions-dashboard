# Code Review — 2026-02-23 (v4)

## Samenvatting

| Aspect | Waarde |
|--------|--------|
| **Verdict** | **CHANGES REQUESTED** |
| **Bestanden** | 4 gereviewed |
| **Bevindingen** | 2 (gefilterd van 8) |
| **Agents** | security-sentinel, avg-privacy-guardian, logic-correctness, async-data-integrity, convention-checker, duplication-checker, python-specialist |

## Vereist menselijke beoordeling

### [HIGH] ASD-001 — resume_session mist _session_lock — TOCTOU race bij concurrent resume
**Bestand:** `lib/store.py:447-471` | **Confidence:** 0.90 | **Agent:** async-data-integrity

De concurrency hardening voegt `_session_lock` toe aan alle session-mutating functies, maar `resume_session` is overgeslagen. Deze functie doet een read-modify-write op twee sessies zonder lock. Concreet scenario: twee processen roepen tegelijkertijd `resume_session` aan op dezelfde parked sessie — resulteert in twee actieve sessies uit dezelfde parked sessie.

**Suggestie:** Wrap de volledige `resume_session` in `_session_lock(session_id)` zodat de read-check-create-write cyclus atomair is.

## Overige bevindingen

### [MEDIUM] LOG-001 — update_task subject-rename breekt dedup-invariant van add_tasks
**Bestand:** `lib/store.py:367-391` | **Confidence:** 0.90 | **Agent:** logic-correctness

`update_task` controleert niet of een nieuw subject al bestaat bij een andere task. `add_tasks` dedupliceert op subject, maar `update_task` omzeilt die check. Twee tasks met hetzelfde subject worden mogelijk.

**Suggestie:** Voeg een dedup-check toe vóór het overschrijven van het subject.

## Compound Learning

De volgende eerder gerapporteerde issues zijn gefixt en vastgelegd als solution documents:
- **ASD-001**: update_session mist lock → `docs/solutions/database/SOL-2026-009-update-session-mist-lock.md`
- **ASD-002**: complete_session/park_session mist lock → `docs/solutions/database/SOL-2026-010-complete-park-session-mist-lock.md`
- **ASD-003**: heartbeat_project mist lock → `docs/solutions/database/SOL-2026-011-heartbeat-project-mist-lock.md`
- **LOG-002**: update_task crash niet-bestaande sessie → `docs/solutions/logic/SOL-2026-012-update-task-crash-niet-bestaande-sessie.md`
- **LOG-001**: heartbeat UnboundLocalError → `docs/solutions/logic/SOL-2026-013-heartbeat-unbound-local-error.md`
- **LOG-003**: Verouderde now in cleanup → `docs/solutions/logic/SOL-2026-014-verouderde-now-cleanup-revalidatie.md`
