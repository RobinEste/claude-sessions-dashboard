# Code Review — 2026-02-25

## Samenvatting

| Aspect | Waarde |
|--------|--------|
| **Verdict** | approve |
| **Risk Score** | 30/100 (Laag) |
| **Bestanden** | 7 gereviewed |
| **Bevindingen** | 6 (gefilterd van 12) |
| **Agents** | security-sentinel, avg-privacy-guardian, logic-correctness, async-data-integrity, convention-checker, duplication-checker, python-specialist |

## Bevindingen

### SEC-001 — Path traversal via session_id (medium)
**`lib/store.py:73-185`** | confidence: 0.85

`get_session()` en `_session_lock()` bouwen paden via `SESSIONS_DIR / f"{session_id}.json"` zonder validatie. Via het web endpoint kan `../../config` bestanden buiten de sessions dir lezen.

Suggestie: Voeg een `_validate_session_id()` helper toe met `path.resolve().is_relative_to(SESSIONS_DIR)` of een strict regex check.

### LOG-002 — update_task muteert status voor subject-validatie (medium)
**`lib/store.py:381-394`** | confidence: 0.80

Status en `updated_at` worden gemuteerd voordat de subject-duplicaat check plaatsvindt. Bij `ValueError` heeft de caller een inconsistent in-memory object.

Suggestie: Verplaats de subject-check voor de status/updated_at mutaties.

### DUP-001 — Drievoudige dict-comprehension in build_overview (medium)
**`lib/store.py:736-801`** | confidence: 0.95

Drie bijna identieke dict-comprehensions voor active/parked/completed. ~12 gedeelde velden op 3 plekken. Al een concrete inconsistentie: `started_at` ontbreekt bij completed.

Suggestie: Extraheer een `_session_to_overview_dict()` helper.

### ASD-001 — resume_session roept create_session aan binnen lock (medium)
**`lib/store.py:450-475`** | confidence: 0.80

`create_session()` binnen de lock van de oude sessie leidt tot tijdelijk inconsistente project state en onnodig lang gehouden lock.

Suggestie: Verplaats `create_session()` buiten de lock.

### LOG-001 — KeyError bij tasks zonder 'subject' key (medium)
**`lib/store.py:344`** | confidence: 0.80

`{t['subject'] for t in session.tasks}` crasht als een task geen `subject` key heeft (legacy data/handmatige edit).

Suggestie: Gebruik `t.get('subject', '')` met defensieve filtering.

### CON-001 — Task statussen als plain strings i.p.v. StrEnum (medium)
**`lib/store.py:225`** | confidence: 0.90

`VALID_TASK_STATUSES` is een losse set, terwijl `SessionStatus` een `StrEnum` is. Inconsistent patroon.

Suggestie: Definieer `TaskStatus(StrEnum)` in `lib/models.py`.
