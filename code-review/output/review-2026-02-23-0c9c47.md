# Code Review — 2026-02-23

## Samenvatting

| Aspect | Waarde |
|--------|--------|
| **Verdict** | **CHANGES REQUESTED** |
| **Bestanden** | 5 gereviewed |
| **Bevindingen** | 4 (gefilterd van 12) |
| **Agents** | security-sentinel, avg-privacy-guardian, logic-correctness, async-data-integrity, convention-checker, duplication-checker, python-specialist |

## Vereist menselijke beoordeling

### [HIGH] ASD-001 — Race condition op task-ID generatie in add_task / add_tasks
**Bestand:** `lib/store.py:295-345` | **Confidence:** 0.85 | **Agent:** async-data-integrity

Beide functies berekenen `max_id` via `max(int(t['id'][1:]) for t in session.tasks)` op het moment van lezen, en schrijven daarna terug. Als twee processen (bijv. twee parallelle Claude-agents op dezelfde sessie) tegelijk `add_task` aanroepen, lezen ze allebei dezelfde `max_id`, berekenen allebei dezelfde volgende ID, en schrijven allebei weg via `_atomic_write`. Het laatste write wint (door `os.replace`), waardoor één taak verloren gaat maar wél de ID claimt.

**Suggestie:** Gebruik uuid-gebaseerde task IDs of `fcntl.flock` op het sessie-bestand voor de hele read-modify-write cyclus.

---

### [HIGH] ASD-002-PYT-001-CON-002 — Schrijfoperatie in GET /api/overview
**Bestand:** `web/app.py:33-35` | **Confidence:** 0.92 | **Agents:** async-data-integrity, python-specialist, convention-checker

Bij elke GET /api/overview wordt `cleanup_stale_sessions()` aangeroepen. Dit schendt HTTP-semantiek (GET moet idempotent zijn), veroorzaakt race conditions bij meerdere gelijktijdige requests, en gaat in tegen de architectuurconventie dat leesfuncties geen schrijfoperaties uitvoeren. Er is al een aparte launchd cleanup job aanwezig — de inline cleanup is redundant.

**Suggestie:** Verwijder de cleanup uit de hot path en laat de bestaande launchd job dit afhandelen.

## Overige bevindingen

### [MEDIUM] LOG-001-DUP-001 — task_summary inconsistent en driemaal gedupliceerd
**Bestand:** `lib/store.py:688-747` | **Confidence:** 0.92 | **Agents:** logic-correctness, duplication-checker

`task_summary.total` telt alle tasks (inclusief skipped), maar `completed + in_progress + pending` telt skipped niet mee. Het blok is driemaal identiek gedupliceerd in `build_overview()`.

**Suggestie:** Extraheer een `_task_summary(tasks)` helper en voeg `skipped` toe aan de telling.

---

### [MEDIUM] ASD-003 — Partial failure in cleanup_stale_sessions
**Bestand:** `lib/store.py:501-512` | **Confidence:** 0.80 | **Agent:** async-data-integrity

Als `_save_session` slaagt maar `_refresh_project_state` een exception gooit, stopt de loop. Overgebleven stale sessies worden niet verwerkt en de project-state van al verwerkte sessies blijft permanent inconsistent.

**Suggestie:** Verplaats `_refresh_project_state` naar na de loop (per project-slug), met try/except per sessie.
