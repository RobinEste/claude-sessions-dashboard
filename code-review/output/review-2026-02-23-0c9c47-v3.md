# Code Review — 2026-02-23 (v3)

## Samenvatting

| Aspect | Waarde |
|--------|--------|
| **Verdict** | **CHANGES REQUESTED** |
| **Bestanden** | 4 gereviewed |
| **Bevindingen** | 6 (gefilterd van 12) |
| **Agents** | security-sentinel, avg-privacy-guardian, logic-correctness, async-data-integrity, convention-checker, duplication-checker, python-specialist |

## Vereist menselijke beoordeling

### [HIGH] ASD-001 — update_session mist _session_lock: onbeschermde read-modify-write
**Bestand:** `lib/store.py:239-250` | **Confidence:** 0.95 | **Agent:** async-data-integrity

De functie `update_session` doet een read-modify-write cyclus (get_session → setattr → _save_session) zonder `_session_lock`. Alle andere schrijffuncties (add_event, add_commit, add_decision, add_task, update_task, etc.) zijn in deze PR voorzien van een lock — maar `update_session` niet. Concreet scenario: een Claude-sessie roept `update_session(id, current_activity='...')` aan terwijl tegelijkertijd `add_event` loopt. De `add_event` leest de session, voegt een event toe en schrijft terug. Vervolgens leest `update_session` een stale versie (van vóór de add_event-write), overschrijft current_activity en schrijft terug — het zojuist toegevoegde event is verloren.

**Suggestie:** Wrap de body van `update_session` in `with _session_lock(session_id):`.

---

### [HIGH] ASD-002 — complete_session en park_session missen _session_lock bij status-transitie
**Bestand:** `lib/store.py:392-419` | **Confidence:** 0.90 | **Agent:** async-data-integrity

Beide functies doen een onbeschermde read-modify-write: ze lezen de session, muteren status/ended_at/outcome en schrijven terug zonder lock. Concreet scenario: een heartbeat-schrijfoperatie loopt gelijktijdig met complete_session — de heartbeat-update gaat verloren. Ernstiger: als `cleanup_stale_sessions` tegelijkertijd loopt, kan het outcome-veld van één schrijver de andere overschrijven.

**Suggestie:** Wrap de body van `complete_session` en `park_session` elk in `with _session_lock(session_id):`.

---

### [HIGH] LOG-002 — update_task() gooit misleidende ValueError bij niet-bestaande sessie
**Bestand:** `lib/store.py:365-389` | **Confidence:** 0.95 | **Agent:** logic-correctness

Als `get_session()` None retourneert, crasht de functie met een AttributeError (itereren over `None.tasks`). Het kernprobleem is de ontbrekende None-check na `get_session()`.

**Suggestie:** Voeg `if not session: return None` toe na `get_session()`, vóór de for-loop.

## Overige bevindingen

### [MEDIUM] LOG-001 — heartbeat() kan UnboundLocalError gooien bij verwijderde sessie
**Bestand:** `lib/store.py:219-226` | **Confidence:** 0.90 | **Agent:** logic-correctness

In `heartbeat()` wordt `session` gedeclareerd binnen de `with _session_lock`-block. Bij de `return session` buiten het with-block kan dit een `UnboundLocalError` geven als de sessie niet bestaat.

**Suggestie:** Initialiseer `session = None` vóór de `with`-block.

---

### [MEDIUM] ASD-003 — heartbeat_project mist _session_lock terwijl heartbeat dat wel heeft
**Bestand:** `lib/store.py:229-236` | **Confidence:** 0.80 | **Agent:** async-data-integrity

De bulk-variant `heartbeat_project` itereert over sessies en schrijft zonder lock, terwijl de enkelvoudige `heartbeat()` wel gelockt is. Dit ondermijnt de locking-garanties.

**Suggestie:** Roep de gelocked `heartbeat()`-functie aan per sessie in de loop.

---

### [MEDIUM] LOG-003 — cleanup_stale_sessions() gebruikt verouderde `now` voor staleness-revalidatie
**Bestand:** `lib/store.py:524-561` | **Confidence:** 0.85 | **Agent:** logic-correctness

De variabele `now` wordt eenmalig bepaald vóór de loop. Bij langlopende cleanup-runs kan een sessie die ondertussen een heartbeat kreeg toch onterecht als stale worden gesloten.

**Suggestie:** Gebruik `datetime.now(timezone.utc)` per iteratie in plaats van de gedeelde `now`.

## Compound Learning

De volgende eerder gerapporteerde issues zijn gefixt en vastgelegd als solution documents:
- **ASD-001**: TOCTOU race file-locking → `docs/solutions/database/SOL-2026-004-toctou-race-file-locking.md`
- **ASD-002**: Heartbeat hervalidatie cleanup → `docs/solutions/database/SOL-2026-005-heartbeat-hervalidatie-cleanup.md`
- **ASD-003**: last_heartbeat sync cleanup → `docs/solutions/database/SOL-2026-006-last-heartbeat-sync-cleanup.md`
- **PYT-001**: Status validatie update_task → `docs/solutions/database/SOL-2026-007-status-validatie-update-task.md`
- **PYT-002**: Exception logging cleanup → `docs/solutions/database/SOL-2026-008-exception-logging-cleanup.md`
