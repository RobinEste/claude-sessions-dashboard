<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Claude Sessions Dashboard</title>
<style>
  :root {
    --bg: #22272e;
    --bg-card: #2d333b;
    --bg-hover: #373e47;
    --border: #444c56;
    --text: #adbac7;
    --text-muted: #768390;
    --text-bright: #cdd9e5;
    --accent-green: #57ab5a;
    --accent-blue: #539bf5;
    --accent-orange: #c69026;
    --accent-red: #e5534b;
    --accent-purple: #986ee2;
    --radius: 8px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.5;
    padding: 24px;
    max-width: 960px;
    margin: 0 auto;
  }

  header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 16px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 16px;
  }

  header h1 {
    color: var(--text-bright);
    font-size: 20px;
    font-weight: 600;
  }

  header .updated {
    color: var(--text-muted);
    font-size: 13px;
  }

  /* Search and filter bar */
  .search-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
    align-items: center;
    flex-wrap: wrap;
  }

  .search-input {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-size: 13px;
    padding: 6px 12px;
    flex: 1;
    min-width: 200px;
    outline: none;
    transition: border-color 0.15s;
  }

  .search-input:focus {
    border-color: var(--accent-blue);
  }

  .search-input::placeholder {
    color: var(--text-muted);
  }

  .filter-select {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text);
    font-size: 13px;
    padding: 6px 10px;
    outline: none;
    cursor: pointer;
  }

  .filter-select:focus {
    border-color: var(--accent-blue);
  }

  .search-clear {
    background: none;
    border: none;
    color: var(--text-muted);
    font-size: 13px;
    cursor: pointer;
    padding: 4px 8px;
    display: none;
  }

  .search-clear:hover {
    color: var(--text);
  }

  /* Filter bar */
  .filters {
    display: flex;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .filter-btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 16px;
    color: var(--text-muted);
    font-size: 13px;
    padding: 4px 14px;
    cursor: pointer;
    transition: all 0.15s;
  }

  .filter-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
  }

  .filter-btn.active {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
    color: #fff;
  }

  .filter-count {
    font-size: 11px;
    opacity: 0.8;
    margin-left: 4px;
  }

  /* Session cards */
  .session-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 8px;
    overflow: hidden;
    transition: border-color 0.15s;
  }

  .session-card:hover {
    border-color: var(--text-muted);
  }

  .card-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    cursor: pointer;
    user-select: none;
  }


  .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .dot-active { background: var(--accent-green); }
  .dot-action { background: var(--accent-red); }
  .dot-stale { background: var(--accent-orange); }
  .dot-parked { background: var(--accent-blue); }
  .dot-completed { background: var(--text-muted); }

  .card-intent {
    color: var(--text-bright);
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
  }

  .card-activity {
    color: var(--text-muted);
    font-size: 13px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    min-width: 0;
    flex: 1;
  }

  .card-tags {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
    align-items: center;
  }

  .tag {
    font-size: 11px;
    padding: 1px 8px;
    border-radius: 10px;
    white-space: nowrap;
  }

  .tag-ref {
    background: rgba(152, 110, 226, 0.15);
    color: var(--accent-purple);
  }

  .tag-stale {
    background: rgba(198, 144, 38, 0.15);
    color: var(--accent-orange);
    font-weight: 600;
  }

  .tag-action {
    background: rgba(229, 83, 75, 0.15);
    color: var(--accent-red);
    font-weight: 600;
  }

  .tag-project {
    background: rgba(83, 155, 245, 0.15);
    color: var(--accent-blue);
  }

  .card-time {
    color: var(--text-muted);
    font-size: 12px;
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* Session card hover — indicates clickable */
  .session-card .card-row {
    transition: background 0.15s;
  }

  .session-card .card-row:hover {
    background: var(--bg-hover);
  }

  .detail-branch {
    font-family: 'SF Mono', 'Menlo', monospace;
    background: rgba(83, 155, 245, 0.1);
    padding: 0 6px;
    border-radius: 4px;
    color: var(--accent-blue);
  }

  .detail-label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-muted);
    margin-bottom: 4px;
  }


  /* Detail lists */
  .detail-list {
    list-style: none;
  }

  .detail-list li {
    padding: 2px 0;
    font-size: 13px;
    color: var(--text-muted);
  }

  .detail-list li::before {
    content: '  ';
  }

  .detail-list.files li::before {
    content: '';
    color: var(--accent-blue);
    margin-right: 4px;
  }

  .detail-list.decisions li::before {
    content: '';
    margin-right: 4px;
  }

  .detail-list.questions li::before {
    content: '? ';
    color: var(--accent-orange);
    margin-right: 4px;
  }

  .detail-outcome {
    font-size: 13px;
    color: var(--text);
    padding: 4px 0;
  }

  .detail-reason {
    font-size: 13px;
    color: var(--accent-orange);
    font-style: italic;
    padding: 4px 0;
  }

  .empty-msg {
    color: var(--text-muted);
    font-size: 13px;
    font-style: italic;
    padding: 20px 0;
    text-align: center;
  }

  .error-banner {
    background: var(--accent-red);
    color: #fff;
    padding: 8px 16px;
    border-radius: var(--radius);
    font-size: 13px;
    margin-bottom: 16px;
    display: none;
  }

  /* Project header */
  .project-header {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 12px 16px;
    margin-bottom: 4px;
    margin-top: 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: wrap;
  }

  .project-group:first-child .project-header {
    margin-top: 0;
  }

  .project-header h2 {
    color: var(--text-bright);
    font-size: 15px;
    font-weight: 600;
    margin: 0;
  }

  .project-phase {
    font-size: 12px;
    color: var(--accent-purple);
    background: rgba(152, 110, 226, 0.12);
    padding: 1px 8px;
    border-radius: 10px;
  }

  .project-stats {
    display: flex;
    gap: 12px;
    margin-left: auto;
    font-size: 12px;
    color: var(--text-muted);
  }

  .project-stats .stat-value {
    color: var(--text);
    font-weight: 500;
  }

  /* Event count badge */
  .tag-events {
    background: rgba(173, 186, 199, 0.1);
    color: var(--text-muted);
    font-size: 11px;
    padding: 1px 7px;
    border-radius: 10px;
    font-variant-numeric: tabular-nums;
  }

  /* Detail view */
  .detail-view {
    display: none;
  }

  .detail-view.visible {
    display: block;
  }

  .detail-back {
    background: none;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--accent-blue);
    font-size: 13px;
    padding: 6px 14px;
    cursor: pointer;
    margin-bottom: 16px;
    transition: all 0.15s;
  }

  .detail-back:hover {
    background: var(--bg-hover);
    border-color: var(--accent-blue);
  }

  .detail-export-bar {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }

  .export-btn {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-muted);
    font-size: 12px;
    padding: 5px 12px;
    cursor: pointer;
    transition: all 0.15s;
    text-decoration: none;
    display: inline-block;
  }

  .export-btn:hover {
    background: var(--bg-hover);
    color: var(--text);
    border-color: var(--accent-blue);
  }

  .detail-view-header {
    margin-bottom: 20px;
  }

  .detail-view-title {
    color: var(--text-bright);
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .detail-view-meta {
    display: flex;
    gap: 12px;
    font-size: 12px;
    color: var(--text-muted);
    flex-wrap: wrap;
    align-items: center;
  }

  .detail-view-meta .tag {
    font-size: 12px;
    padding: 2px 10px;
  }

  .detail-view-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 16px;
  }

  @media (max-width: 640px) {
    .detail-view-grid {
      grid-template-columns: 1fr;
    }
  }

  .detail-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 14px 16px;
  }

  .detail-panel-full {
    grid-column: 1 / -1;
  }

  .detail-panel .detail-label {
    margin-bottom: 8px;
  }

  /* Full event timeline */
  .timeline-event {
    display: flex;
    gap: 10px;
    padding: 6px 0;
    font-size: 13px;
    border-bottom: 1px solid var(--border);
  }

  .timeline-event:last-child {
    border-bottom: none;
  }

  .timeline-date {
    color: var(--text-muted);
    font-size: 12px;
    white-space: nowrap;
    flex-shrink: 0;
    min-width: 80px;
  }

  .timeline-msg {
    color: var(--text);
  }

  /* Commit detail */
  .commit-detail {
    display: flex;
    gap: 8px;
    padding: 4px 0;
    font-size: 13px;
    align-items: baseline;
  }

  .commit-detail .commit-sha {
    font-family: 'SF Mono', 'Menlo', monospace;
    font-size: 12px;
  }

  /* File list in detail view */
  .file-item {
    padding: 3px 0;
    font-size: 13px;
    font-family: 'SF Mono', 'Menlo', monospace;
    color: var(--text);
  }

  /* Commits list */
  .detail-list.commits li {
    font-family: 'SF Mono', 'Menlo', monospace;
    font-size: 12px;
  }

  .detail-list.commits li::before {
    content: '';
  }

  .commit-sha {
    color: var(--accent-blue);
    margin-right: 6px;
  }

  .commit-msg {
    color: var(--text);
  }

  /* Next steps list */
  .detail-list.next-steps li::before {
    content: '\2192  ';
    color: var(--accent-green);
    margin-right: 2px;
  }


  /* Task tracking */
  .tag-tasks {
    background: rgba(152, 110, 226, 0.15);
    color: var(--accent-purple);
    font-variant-numeric: tabular-nums;
  }

  .task-progress-bar {
    height: 4px;
    background: var(--border);
    border-radius: 2px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .task-progress-fill {
    height: 100%;
    background: var(--accent-green);
    border-radius: 2px;
    transition: width 0.3s;
  }

  .task-item {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 2px 0;
    font-size: 13px;
  }

  .task-icon {
    flex-shrink: 0;
    width: 14px;
    text-align: center;
  }

  .task-completed .task-icon { color: var(--accent-green); }
  .task-in-progress .task-icon { color: var(--accent-blue); }
  .task-pending .task-icon { color: var(--text-muted); }
  .task-skipped .task-icon { color: var(--text-muted); }
  .task-skipped .task-subject {
    text-decoration: line-through;
    color: var(--text-muted);
  }

  .task-subject {
    color: var(--text);
  }

  footer {
    margin-top: 32px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
    font-size: 12px;
    color: var(--text-muted);
    display: flex;
    gap: 20px;
  }
</style>
</head>
<body>

<header>
  <h1>Claude Sessions</h1>
  <span class="updated" id="last-update">loading...</span>
</header>

<div class="error-banner" id="error-banner"></div>

<!-- List view -->
<div id="list-view">
  <div class="search-bar">
    <input type="text" class="search-input" id="search-input" placeholder="Search sessions...">
    <button class="search-clear" id="search-clear">clear</button>
    <select class="filter-select" id="project-filter">
      <option value="">All projects</option>
    </select>
  </div>
  <div class="filters" id="filters"></div>
  <div id="sessions"></div>
</div>

<!-- Detail view -->
<div class="detail-view" id="detail-view"></div>

<footer id="footer"></footer>

<script>
const POLL_INTERVAL = 30000;
let errorCount = 0;
let currentFilter = 'all';
let currentProject = '';
let searchQuery = '';
let lastData = null;
let currentDetailId = null;  // session_id when in detail view
let detailData = null;       // full session data for detail view

function timeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  const days = Math.floor(hrs / 24);
  return days + (days === 1 ? ' day' : ' days') + ' ago';
}

function formatTime(iso) {
  if (!iso) return '';
  return new Date(iso).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function formatDuration(startIso, endIso) {
  if (!startIso || !endIso) return '';
  const ms = new Date(endIso).getTime() - new Date(startIso).getTime();
  const mins = Math.round(ms / 60000);
  if (mins < 1) return '< 1 min';
  if (mins < 60) return mins + ' min';
  const hrs = Math.floor(mins / 60);
  const rem = mins % 60;
  return hrs + 'h' + (rem > 0 ? ' ' + rem + 'm' : '');
}

function formatElapsed(startIso) {
  if (!startIso) return '';
  const ms = Date.now() - new Date(startIso).getTime();
  const mins = Math.floor(ms / 60000);
  if (mins < 1) return '< 1m';
  if (mins < 60) return mins + 'm';
  const hrs = Math.floor(mins / 60);
  const rem = mins % 60;
  return hrs + 'h' + (rem > 0 ? ' ' + rem + 'm' : '');
}

function esc(s) {
  if (!s) return '';
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

function collectSessions(data) {
  const sessions = [];
  for (const p of data.projects) {
    for (const s of (p.active_sessions || [])) {
      sessions.push({ ...s, type: 'active', project_name: p.name, project_slug: p.slug });
    }
    for (const s of (p.parked_sessions || [])) {
      sessions.push({ ...s, type: 'parked', project_name: p.name, project_slug: p.slug });
    }
    for (const s of (p.completed_sessions || [])) {
      sessions.push({ ...s, type: 'completed', project_name: p.name, project_slug: p.slug });
    }
  }
  return sessions;
}

function matchesSearch(s, query) {
  if (!query) return true;
  const q = query.toLowerCase();
  if ((s.intent || '').toLowerCase().includes(q)) return true;
  if ((s.outcome || '').toLowerCase().includes(q)) return true;
  if ((s.current_activity || '').toLowerCase().includes(q)) return true;
  if ((s.session_id || '').toLowerCase().includes(q)) return true;
  if ((s.git_branch || '').toLowerCase().includes(q)) return true;
  for (const e of (s.events || [])) {
    if ((e.message || '').toLowerCase().includes(q)) return true;
  }
  for (const d of (s.decisions || [])) {
    if ((d || '').toLowerCase().includes(q)) return true;
  }
  for (const t of (s.tasks || [])) {
    if ((t.subject || '').toLowerCase().includes(q)) return true;
  }
  return false;
}

function filterSessions(sessions, filter) {
  let result = sessions;
  if (filter !== 'all') {
    result = result.filter(s => s.type === filter);
  }
  if (currentProject) {
    result = result.filter(s => s.project_slug === currentProject);
  }
  if (searchQuery) {
    result = result.filter(s => matchesSearch(s, searchQuery));
  }
  return result;
}

function renderFilters(sessions) {
  const counts = { all: sessions.length, active: 0, parked: 0, completed: 0 };
  for (const s of sessions) counts[s.type]++;

  const labels = {
    all: 'All',
    active: 'Active',
    parked: 'Parked',
    completed: 'Completed'
  };

  let html = '';
  for (const [key, label] of Object.entries(labels)) {
    const active = currentFilter === key ? ' active' : '';
    html += '<button class="filter-btn' + active + '" data-filter="' + key + '">';
    html += label + '<span class="filter-count">(' + counts[key] + ')</span>';
    html += '</button>';
  }
  return html;
}

function renderCardRow(s) {
  // Dot priority: awaiting_action > stale > active
  let dotClass = 'dot-active';
  if (s.type === 'parked') dotClass = 'dot-parked';
  else if (s.type === 'completed') dotClass = 'dot-completed';
  else if (s.awaiting_action) dotClass = 'dot-action';
  else if (s.is_stale) dotClass = 'dot-stale';

  // Time display: elapsed for active, timeAgo for others
  let time = '';
  if (s.type === 'active') time = formatElapsed(s.started_at);
  else if (s.type === 'parked') time = timeAgo(s.ended_at);
  else if (s.type === 'completed') time = timeAgo(s.ended_at);

  let html = '<div class="session-card" data-id="' + esc(s.session_id) + '">';
  html += '<div class="card-row" onclick="openDetail(\'' + esc(s.session_id) + '\')">';
  html += '<span class="dot ' + dotClass + '"></span>';
  html += '<span class="card-intent">' + esc(s.intent) + '</span>';

  // Activity text: current_activity, last event as fallback, or outcome for completed
  let activity = s.current_activity || '';
  if (!activity && s.type === 'active' && s.events && s.events.length > 0) {
    activity = s.events[s.events.length - 1].message || '';
  }
  if (!activity && s.type === 'completed' && s.outcome) {
    activity = s.outcome.length > 60 ? s.outcome.substring(0, 57) + '...' : s.outcome;
  }
  html += '<span class="card-activity">' + esc(activity) + '</span>';

  html += '<span class="card-tags">';
  if (s.awaiting_action) {
    html += '<span class="tag tag-action">ACTION: ' + esc(s.awaiting_action) + '</span>';
  }
  if (s.roadmap_ref) {
    html += '<span class="tag tag-ref">' + esc(s.roadmap_ref) + '</span>';
  }
  if (s.is_stale && !s.awaiting_action) {
    html += '<span class="tag tag-stale">STALE</span>';
  }
  const evtCount = s.event_count || (s.events || []).length;
  if (evtCount > 0) {
    html += '<span class="tag tag-events">' + evtCount + ' events</span>';
  }
  const commitCount = (s.commits || []).length;
  if (commitCount > 0) {
    html += '<span class="tag tag-events">' + commitCount + ' commits</span>';
  }
  if (s.tasks && s.tasks.length > 0) {
    const done = s.tasks.filter(t => t.status === 'completed').length;
    html += '<span class="tag tag-tasks">' + done + '/' + s.tasks.length + ' tasks</span>';
  }
  html += '<span class="tag tag-project">' + esc(s.project_name) + '</span>';
  html += '</span>';

  html += '<span class="card-time">' + esc(time) + '</span>';
  html += '</div>';

  html += '</div>';
  return html;
}


function openDetail(id) {
  currentDetailId = id;
  detailData = null;
  showDetailView();
  loadSessionDetail(id);
}

function closeDetail() {
  currentDetailId = null;
  detailData = null;
  showListView();
}

function showDetailView() {
  document.getElementById('list-view').style.display = 'none';
  const dv = document.getElementById('detail-view');
  dv.classList.add('visible');
  dv.innerHTML = '<button class="detail-back" onclick="closeDetail()">&larr; Back to sessions</button><div class="empty-msg">Loading session data...</div>';
}

function showListView() {
  document.getElementById('detail-view').classList.remove('visible');
  document.getElementById('detail-view').innerHTML = '';
  document.getElementById('list-view').style.display = '';
}

async function loadSessionDetail(id) {
  try {
    const resp = await fetch('/api/session/' + encodeURIComponent(id));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    detailData = await resp.json();
    // Enrich with project info from lastData
    if (lastData) {
      for (const p of lastData.projects) {
        for (const list of [p.active_sessions, p.parked_sessions, p.completed_sessions]) {
          for (const s of (list || [])) {
            if (s.session_id === id) {
              detailData._project_name = p.name;
              detailData._is_stale = s.is_stale || false;
              detailData._type = s.is_stale ? 'active' : (detailData.status || 'active');
            }
          }
        }
      }
    }
    if (!detailData._type) detailData._type = detailData.status || 'active';
    if (!detailData._project_name) detailData._project_name = detailData.project_slug;
    renderDetailView();
  } catch (err) {
    const dv = document.getElementById('detail-view');
    dv.innerHTML = '<button class="detail-back" onclick="closeDetail()">&larr; Back to sessions</button>' +
      '<div class="empty-msg">Failed to load session: ' + esc(err.message) + '</div>';
  }
}

function formatDate(iso) {
  if (!iso) return '';
  const d = new Date(iso);
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' }) +
    ' ' + d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function renderDetailView() {
  if (!detailData || currentDetailId !== detailData.session_id) return;
  const s = detailData;
  const dv = document.getElementById('detail-view');

  // Status dot
  let dotClass = 'dot-active';
  if (s.status === 'parked') dotClass = 'dot-parked';
  else if (s.status === 'completed') dotClass = 'dot-completed';
  else if (s._is_stale) dotClass = 'dot-stale';

  let html = '<button class="detail-back" onclick="closeDetail()">&larr; Back to sessions</button>';

  // Export buttons
  const exportBase = '/api/export/session/' + encodeURIComponent(s.session_id);
  html += '<div class="detail-export-bar">';
  html += '<a class="export-btn" href="' + exportBase + '?format=markdown" download>Export Markdown</a>';
  html += '<a class="export-btn" href="' + exportBase + '?format=json" target="_blank">Export JSON</a>';
  html += '</div>';

  // Header
  html += '<div class="detail-view-header">';
  html += '<div class="detail-view-title">';
  html += '<span class="dot ' + dotClass + '"></span>';
  html += esc(s.intent);
  html += '</div>';
  html += '<div class="detail-view-meta">';
  html += '<span>' + esc(s.session_id) + '</span>';
  html += '<span class="tag tag-project">' + esc(s._project_name) + '</span>';
  if (s.roadmap_ref) html += '<span class="tag tag-ref">' + esc(s.roadmap_ref) + '</span>';
  if (s.git_branch) html += '<span class="detail-branch">' + esc(s.git_branch) + '</span>';
  html += '<span>Status: ' + esc(s.status) + '</span>';
  if (s.started_at) html += '<span>Started: ' + formatDate(s.started_at) + '</span>';
  if (s.ended_at) {
    html += '<span>Ended: ' + formatDate(s.ended_at) + '</span>';
    const dur = formatDuration(s.started_at, s.ended_at);
    if (dur) html += '<span>Duration: ' + dur + '</span>';
  } else if (s.status === 'active' && s.started_at) {
    html += '<span>Running: ' + formatElapsed(s.started_at) + '</span>';
  }
  if (s.last_heartbeat) html += '<span>Last active: ' + timeAgo(s.last_heartbeat) + '</span>';
  html += '</div>';
  html += '</div>';

  // Outcome or parked reason — prominent display
  if (s.status === 'completed' && s.outcome) {
    html += '<div class="detail-panel" style="margin-bottom:12px">';
    html += '<div class="detail-label">Outcome</div>';
    html += '<div class="detail-outcome">' + esc(s.outcome) + '</div>';
    html += '</div>';
  }
  if (s.status === 'parked' && s.parked_reason) {
    html += '<div class="detail-panel" style="margin-bottom:12px">';
    html += '<div class="detail-label">Parked reason</div>';
    html += '<div class="detail-reason">' + esc(s.parked_reason) + '</div>';
    html += '</div>';
  }

  // Grid: tasks + event timeline side by side
  html += '<div class="detail-view-grid">';

  // Tasks panel
  const tasks = s.tasks || [];
  if (tasks.length > 0) {
    const completed = tasks.filter(t => t.status === 'completed').length;
    const pct = Math.round((completed / tasks.length) * 100);
    html += '<div class="detail-panel">';
    html += '<div class="detail-label">Tasks (' + completed + '/' + tasks.length + ')</div>';
    html += '<div class="task-progress-bar"><div class="task-progress-fill" style="width:' + pct + '%"></div></div>';
    for (const t of tasks) {
      let icon = '\u25CB', cls = 'task-pending';
      if (t.status === 'completed') { icon = '\u2713'; cls = 'task-completed'; }
      else if (t.status === 'in_progress') { icon = '\u25B8'; cls = 'task-in-progress'; }
      else if (t.status === 'skipped') { icon = '\u2013'; cls = 'task-skipped'; }
      html += '<div class="task-item ' + cls + '">';
      html += '<span class="task-icon">' + icon + '</span>';
      html += '<span class="task-subject">' + esc(t.subject) + '</span>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Event timeline (full)
  const events = s.events || [];
  if (events.length > 0) {
    html += '<div class="detail-panel' + (tasks.length === 0 ? ' detail-panel-full' : '') + '">';
    html += '<div class="detail-label">Event timeline (' + events.length + ')</div>';
    const reversed = [...events].reverse();
    for (const e of reversed) {
      html += '<div class="timeline-event">';
      html += '<span class="timeline-date">' + formatDate(e.timestamp) + '</span>';
      html += '<span class="timeline-msg">' + esc(e.message) + '</span>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Commits
  const commits = s.commits || [];
  if (commits.length > 0) {
    html += '<div class="detail-panel">';
    html += '<div class="detail-label">Commits (' + commits.length + ')</div>';
    for (const c of commits) {
      html += '<div class="commit-detail">';
      html += '<span class="commit-sha">' + esc((c.sha || '').substring(0, 7)) + '</span>';
      html += '<span class="commit-msg">' + esc(c.message || '') + '</span>';
      html += '</div>';
    }
    html += '</div>';
  }

  // Files changed
  const files = s.files_changed || [];
  if (files.length > 0) {
    html += '<div class="detail-panel">';
    html += '<div class="detail-label">Files changed (' + files.length + ')</div>';
    for (const f of files) {
      html += '<div class="file-item">' + esc(f) + '</div>';
    }
    html += '</div>';
  }

  // Decisions
  const decisions = s.decisions || [];
  if (decisions.length > 0) {
    html += '<div class="detail-panel">';
    html += '<div class="detail-label">Decisions (' + decisions.length + ')</div>';
    html += '<ul class="detail-list decisions">';
    for (const d of decisions) {
      html += '<li>' + esc(d) + '</li>';
    }
    html += '</ul>';
    html += '</div>';
  }

  // Open questions
  const questions = s.open_questions || [];
  if (questions.length > 0) {
    html += '<div class="detail-panel">';
    html += '<div class="detail-label">Open questions (' + questions.length + ')</div>';
    html += '<ul class="detail-list questions">';
    for (const q of questions) {
      html += '<li>' + esc(q) + '</li>';
    }
    html += '</ul>';
    html += '</div>';
  }

  // Next steps
  const nextSteps = s.next_steps || [];
  if (nextSteps.length > 0) {
    html += '<div class="detail-panel">';
    html += '<div class="detail-label">Next steps</div>';
    html += '<ul class="detail-list next-steps">';
    for (const ns of nextSteps) {
      html += '<li>' + esc(ns) + '</li>';
    }
    html += '</ul>';
    html += '</div>';
  }

  html += '</div>'; // close grid

  dv.innerHTML = html;
}

function renderProjectHeader(p) {
  let html = '<div class="project-header">';
  html += '<h2>' + esc(p.name) + '</h2>';
  if (p.current_phase) {
    html += '<span class="project-phase">' + esc(p.current_phase) + '</span>';
  }
  html += '<div class="project-stats">';
  html += '<span>Sessions: <span class="stat-value">' + p.total_sessions + '</span></span>';
  if (p.active_count > 0) {
    html += '<span>Active: <span class="stat-value">' + p.active_count + '</span></span>';
  }
  if (p.parked_count > 0) {
    html += '<span>Parked: <span class="stat-value">' + p.parked_count + '</span></span>';
  }
  const rs = p.roadmap_summary || {};
  if (rs.completed_count > 0 || rs.in_progress_count > 0) {
    html += '<span>Roadmap: <span class="stat-value">' + (rs.completed_count || 0) + ' done, ' + (rs.in_progress_count || 0) + ' active</span></span>';
  }
  if (p.last_activity) {
    html += '<span>Last: ' + timeAgo(p.last_activity) + '</span>';
  }
  html += '</div>';
  html += '</div>';
  return html;
}


function renderProjectDropdown(data) {
  const select = document.getElementById('project-filter');
  const projects = data.projects || [];
  // Only show dropdown if there are multiple projects
  if (projects.length <= 1) {
    select.style.display = 'none';
    return;
  }
  select.style.display = '';
  const current = select.value;
  let html = '<option value="">All projects</option>';
  for (const p of projects) {
    const sel = p.slug === current ? ' selected' : '';
    html += '<option value="' + esc(p.slug) + '"' + sel + '>' + esc(p.name) + '</option>';
  }
  select.innerHTML = html;
}

function render() {
  if (!lastData) return;

  const all = collectSessions(lastData);
  const filtered = filterSessions(all, currentFilter);

  // Project dropdown
  renderProjectDropdown(lastData);

  // Search clear button
  const clearBtn = document.getElementById('search-clear');
  clearBtn.style.display = searchQuery ? 'block' : 'none';

  // Filters (counts reflect search + project filter, not status filter)
  document.getElementById('filters').innerHTML = renderFilters(
    all.filter(s => matchesSearch(s, searchQuery) && (!currentProject || s.project_slug === currentProject))
  );

  // Bind filter clicks
  for (const btn of document.querySelectorAll('.filter-btn')) {
    btn.addEventListener('click', function() {
      currentFilter = this.dataset.filter;
      render();
    });
  }

  // Session cards grouped by project
  const container = document.getElementById('sessions');
  if (filtered.length === 0) {
    const msg = searchQuery ? 'No sessions matching "' + esc(searchQuery) + '"' : 'No sessions found';
    container.innerHTML = '<div class="empty-msg">' + msg + '</div>';
  } else {
    let html = '';
    for (const p of lastData.projects) {
      if (currentProject && p.slug !== currentProject) continue;
      const projectSessions = filtered.filter(s => s.project_slug === p.slug);
      if (projectSessions.length === 0) continue;
      html += '<div class="project-group">';
      html += renderProjectHeader(p);
      html += projectSessions.map(renderCardRow).join('');
      html += '</div>';
    }
    container.innerHTML = html || '<div class="empty-msg">No sessions found</div>';
  }
}

async function refresh() {
  try {
    const resp = await fetch('/api/overview');
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    lastData = await resp.json();

    document.getElementById('last-update').textContent =
      'Updated: ' + new Date(lastData.timestamp).toLocaleTimeString();

    render();

    // Footer
    const s = lastData.settings;
    document.getElementById('footer').innerHTML =
      '<span>Port: ' + s.dashboard_port + '</span>' +
      '<span>Stale after: ' + s.stale_threshold_hours + 'h</span>' +
      '<span>Archive after: ' + s.archive_after_days + ' days</span>' +
      '<span>Poll: every ' + (POLL_INTERVAL / 1000) + 's</span>';

    errorCount = 0;
    document.getElementById('error-banner').style.display = 'none';

  } catch (err) {
    errorCount++;
    const banner = document.getElementById('error-banner');
    banner.textContent = 'Connection failed (' + errorCount + 'x): ' + err.message;
    banner.style.display = 'block';
  }
}

// Search input — debounced
let searchTimeout = null;
document.getElementById('search-input').addEventListener('input', function() {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(function() {
    searchQuery = document.getElementById('search-input').value.trim();
    render();
  }, 200);
});

document.getElementById('search-clear').addEventListener('click', function() {
  searchQuery = '';
  document.getElementById('search-input').value = '';
  render();
});

// Project filter
document.getElementById('project-filter').addEventListener('change', function() {
  currentProject = this.value;
  render();
});

// Initial load + polling
refresh();
setInterval(refresh, POLL_INTERVAL);
</script>
</body>
</html>
