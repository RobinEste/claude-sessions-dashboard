# KNW-2026-002: Invariant-consistentie tussen add- en update-functies

## Metadata
- **Categorie:** architectuur
- **Relevantie:** hoog
- **Datum:** 2026-02-23
- **Sessie-context:** Task tracking met subject-deduplicatie in add_tasks en update_task

## Inzicht

Wanneer een collectie een uniekheids-invariant heeft via een add-functie (bijv. deduplicatie op subject), moet elke update-functie op hetzelfde veld dezelfde invariant afdwingen. Anders kan de invariant via een omweg worden doorbroken.

## Context

`add_tasks` dedupliceert op subject: als een task met hetzelfde subject al bestaat, wordt deze overgeslagen. Maar `update_task` had oorspronkelijk geen check bij het hernoemen van een task — waardoor twee tasks met hetzelfde subject konden ontstaan.

## Geleerd

- Definieer invarianten expliciet (bijv. "task subjects zijn uniek binnen een sessie").
- Controleer bij elke functie die het betreffende veld kan wijzigen of de invariant wordt gehandhaafd.
- Een goede test: als functie A een constraint afdwingt, zoek alle functies die hetzelfde veld muteren en verifieer dat ze dezelfde constraint respecteren.

## Toepassing

- Bij elke collectie met uniekheids-constraints (user emails, slug-velden, tag-namen).
- Geldt ook voor database-level constraints: als de DB een UNIQUE index heeft, hoef je het niet in code te doen — maar bij file-based stores is er geen database om het af te vangen.
