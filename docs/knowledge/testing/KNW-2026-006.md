# KNW-2026-006: Test isolation via monkeypatch van module-level paden

## Metadata
- **Categorie:** testing
- **Relevantie:** hoog
- **Datum:** 2026-02-25
- **Sessie-context:** Opzetten van volledige test suite (130 tests) voor file-based JSON store

## Inzicht

Bij het testen van modules die module-level constanten gebruiken als bestandspaden (bijv. `SESSIONS_DIR`, `CONFIG_PATH`), is `monkeypatch.setattr` op die module-variabelen de meest effectieve isolatiestrategie. Dit voorkomt dat tests de echte data raken zonder mock-objecten te introduceren die het gedrag van file I/O maskeren.

## Context

De store module definieert paden als module-level variabelen:
```python
SESSIONS_DIR = DASHBOARD_DIR / "sessions"
PROJECTS_DIR = DASHBOARD_DIR / "projects"
CONFIG_PATH = DASHBOARD_DIR / "config.json"
```

Tests moeten met echte bestanden werken (geen mocking van JSON I/O) maar mogen niet de productiedata raken.

## Geleerd

- Gebruik `monkeypatch.setattr(store, "SESSIONS_DIR", tmp_path / "sessions")` in een `autouse=True` fixture
- Patch **alle** pad-variabelen die de module exporteert — vergeet er één, en tests schrijven naar productie
- Roep `_ensure_dirs()` aan na het patchen zodat de temp directories bestaan
- Dit patroon werkt beter dan environment variables of dependency injection voor simpele file-based stores

## Toepassing

Toepasbaar op elke Python module die module-level pad-constanten gebruikt voor data opslag. Bijzonder relevant voor CLI tools en file-based stores waar je echte I/O wilt testen zonder de productieomgeving te raken.
