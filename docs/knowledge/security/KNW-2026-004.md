# KNW-2026-004: TOCTOU-preventie met double-check na lock-acquisitie

## Metadata
- **Categorie:** security
- **Relevantie:** hoog
- **Datum:** 2026-02-23
- **Sessie-context:** Auto-cleanup van stale sessies met heartbeat-hervalidatie

## Inzicht

Bij deferred-actions op state (bijv. cleanup jobs, batch-operaties) moet de conditie altijd opnieuw worden gevalideerd binnen de lock. Tussen het ophalen van een lijst "te verwerken items" en het daadwerkelijk verwerken kan de state veranderd zijn.

## Context

`cleanup_stale_sessions` haalt eerst een lijst stale sessies op, en itereert daar vervolgens overheen. Tussen het ophalen en het sluiten van een sessie kan die sessie een heartbeat hebben ontvangen — waardoor een actieve sessie onterecht wordt afgesloten.

## Geleerd

- **Double-check patroon:** Na het verkrijgen van de lock, herlaad de entiteit en controleer opnieuw of de conditie nog geldig is.
- Gebruik een actuele timestamp per iteratie (`datetime.now()` binnen de loop), niet een gedeelde timestamp van vóór de loop.
- Dit patroon is analoog aan double-checked locking in Java/C++ — maar dan voor file-based state.
- De kosten van een extra `get_session()` call zijn verwaarloosbaar vergeleken met het risico van data-destructie.

## Toepassing

- Elke batch-operatie die items verwerkt op basis van een eerder opgehaalde lijst.
- Cron-jobs en background workers die state muteren.
- Database-operaties waar de query en de mutatie niet in dezelfde transactie zitten.
