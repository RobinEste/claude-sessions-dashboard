# KNW-2026-016: State-update alleen bij succesvolle actie — geen cooldown zonder effect

## Metadata
- **Categorie:** development
- **Relevantie:** hoog
- **Datum:** 2026-02-28
- **Sessie-context:** D5 Desktop notificaties — review finding LOG-001

## Inzicht

Wanneer een systeem een cooldown of rate limit bijhoudt voor een actie, mag de cooldown-timer alleen gestart worden als de actie daadwerkelijk is geslaagd. Als de actie faalt (timeout, platform niet ondersteund, service onbereikbaar), moet het systeem bij de volgende cyclus opnieuw kunnen proberen in plaats van geblokkeerd te worden door een cooldown die nooit resultaat heeft opgeleverd.

## Context

In `lib/notify.py` werd `state[session_id]` met een `notified_at` timestamp bijgewerkt ongeacht of `_send_notification()` `True` of `False` retourneerde. Op niet-macOS platforms retourneert deze functie altijd `False`, waardoor de cooldown werd geactiveerd zonder dat er ooit een notificatie was afgeleverd. Het systeem stopte effectief met herproberen.

## Geleerd

- **Faal-scenario's doordenken:** Test niet alleen het happy path, maar ook wat er gebeurt als de onderliggende operatie faalt. State-updates die gekoppeld zijn aan het resultaat moeten conditioneel zijn.
- **Guard-patroon:** Wrap state-updates in `if success:` blokken. Dit geldt voor cooldowns, retry-counters, rate limiters, en circuit breakers.
- **Idempotent bij falen:** Een gefaalde poging moet het systeem in dezelfde toestand achterlaten als voor de poging — alsof er niets is gebeurd.

## Toepassing

- Retry-mechanismen: tel alleen succesvolle pogingen voor backoff-berekeningen.
- Rate limiters: consumeer alleen quota bij succesvolle verwerking.
- Circuit breakers: tel alleen daadwerkelijke fouten, niet pogingen die niet eens gestart zijn.
- Notificatiesystemen: markeer alleen als "verzonden" als de notificatie daadwerkelijk is afgeleverd.
