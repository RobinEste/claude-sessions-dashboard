# KNW-2026-005: Cross-cutting concerns vereisen volledige inventarisatie

## Metadata
- **Categorie:** development
- **Relevantie:** midden
- **Datum:** 2026-02-23
- **Sessie-context:** Toevoegen van file-locking aan alle session-mutating functies

## Inzicht

Bij het toevoegen van een cross-cutting concern (locking, logging, validatie) aan een bestaande codebase, is het cruciaal om ALLE relevante functies te inventariseren. Gemiste functies worden pas gevonden in de volgende review-ronde of — erger — in productie.

## Context

De eerste locking-implementatie (v2) wrapte 9 functies. Review v3 ontdekte dat `update_session`, `complete_session`, en `park_session` waren overgeslagen. Na de fix ontdekte review v4 dat `resume_session` ook was gemist. Elke gemiste functie was een potentiële race condition.

## Geleerd

- Maak een expliciete checklist van ALLE functies die het concern raken voordat je begint met implementatie.
- Zoek op het patroon dat beschermd moet worden (bijv. `get_session` gevolgd door `_save_session`) in plaats van op functienamen.
- Een grep op `_save_session` had alle 13 schrijffuncties direct gevonden — systematisch zoeken is effectiever dan handmatig inventariseren.
- Review agents zijn goed in het detecteren van inconsistenties ("functie X heeft lock, functie Y niet") maar vinden ze pas als het contrast zichtbaar is.

## Toepassing

- Bij het toevoegen van authenticatie-checks aan endpoints.
- Bij het toevoegen van audit-logging aan mutatie-functies.
- Bij het migreren van sync naar async code.
- Algemeen: elke wijziging die "overal" moet worden toegepast.
